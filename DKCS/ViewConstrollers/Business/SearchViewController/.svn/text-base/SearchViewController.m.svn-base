//
//  SearchViewController.m
//  DKCS
//
//  Created by 銀色魔頭號 on 2017/8/30.
//  Copyright © 2017年 IIIidan Stromrage. All rights reserved.
//

#import "SearchViewController.h"
#import "SearchFilterDropDownView.h"
#import "LoanCell.h"

@import YNDropDownMenu;

@interface SearchViewController () <UITableViewDelegate, UITableViewDataSource>

@property (nonatomic, strong) SearchViewModel *viewModel;
@property (nonatomic, copy) NSArray *dropDownViews;

@property (nonatomic, strong) UIView *topLine;
@property (nonatomic, strong) YNDropDownMenu *dropDownMenu;
@property (nonatomic, strong) UITableView *tableView;

@end

@implementation SearchViewController

- (instancetype)initWithViewModel:(SearchViewModel *)viewModel
{
    if (self = [super init]) {
        
        // TopLine.
        self.topLine = [[UIView alloc] initWithFrame:CGRectZero];
        self.topLine.backgroundColor = [UIColor colorWithHexString:@"#CCCCCC"];
        
        // DropDownMenu.
        CGFloat w = [UIScreen mainScreen].bounds.size.width;
        NSMutableArray *arr = [NSMutableArray array];
        for (NSInteger i = 0; i < 3; i++ ) {
            SearchFilterDropDownView *view = [[SearchFilterDropDownView alloc] initWithFrame:CGRectMake(0, 0, w, 108)];
            view.backgroundColor = [UIColor whiteColor];
            [arr addObject:view];
            view = nil;
        }
        
        self.dropDownViews = arr;
        
        self.dropDownMenu = [[YNDropDownMenu alloc] initWithFrame:CGRectMake(0, 65, w, 40)
                                                    dropDownViews:self.dropDownViews
                                               dropDownViewTitles:@[ @"所有贷款类型", @"金额不限", @"期限不限" ]];
        [self.dropDownMenu setLabelWithFont:[UIFont fontWithName:kCommonFont size:12.f]];
        UIColor *color = [UIColor colorWithHexString:@"#333333"];
        [self.dropDownMenu setLabelColorWhenNormal:color selected:color disabled:color];
        [self.dropDownMenu setImageWhenNormal:[UIImage imageNamed:@"下拉箭头"] selected:[UIImage imageNamed:@"下拉箭头"] disabled:nil];
        self.dropDownMenu.backgroundBlurEnabled = YES;
        
        UIView *backgroundView = [UIView new];
        backgroundView.backgroundColor = [UIColor blackColor];
        self.dropDownMenu.blurEffectView = backgroundView;
        self.dropDownMenu.blurEffectViewAlpha = 0.7f;
        
        for (SearchFilterDropDownView *view in self.dropDownViews) {
            @weakify(self);
            NSUInteger index = [self.dropDownViews indexOfObject:view];
            view.didSelectedCellBlock = ^(SearchFilterCell *cell) {
                @strongify(self);
                [self.dropDownMenu changeMenuWithTitle:cell.textLabel.text at:index];
                [self.dropDownMenu hideMenu];
            };
        }
        
        // tableView.
        self.tableView = [[UITableView alloc] initWithFrame:CGRectZero style:UITableViewStylePlain];
        self.tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
        self.tableView.backgroundColor = [UIColor colorWithHexString:@"#F8F8F8"];
        self.tableView.rowHeight = 80.f;
        self.tableView.delegate = self;
        self.tableView.dataSource = self;
        [self.tableView registerClass:[LoanCell class] forCellReuseIdentifier:NSStringFromClass([LoanCell class])];
        
    }
    return self;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    
    [self.view addSubview:self.topLine];
    [self.view addSubview:self.dropDownMenu];
    [self.view addSubview:self.tableView];
    
    [self.view bringSubviewToFront:self.dropDownMenu];
}

- (void)setupConstraints
{
    // TopLine.
    [self.topLine mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.mas_equalTo(0);
        make.top.mas_equalTo(64);
        make.height.mas_equalTo(0.5);
    }];
    
    // tableView.
    [self.tableView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.mas_equalTo(0);
        make.top.mas_equalTo(115);
        make.bottom.mas_equalTo(-49);
    }];
}

#pragma mark - UITableView methods.

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section
{
    return 9;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath
{
    LoanCell *cell = [tableView dequeueReusableCellWithIdentifier:NSStringFromClass([LoanCell class])];
    
    if (cell == nil) {
        cell = [[LoanCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:NSStringFromClass([LoanCell class])];
    }
    cell.backgroundColor = [UIColor whiteColor];
    cell.selectionStyle = UITableViewCellSelectionStyleNone;
    
    cell.titleLabel.text = @"小花钱包-急速借贷";
    cell.nameLabel.text = @"小花钱包";
    [cell.loanLimitLabel setText:@"额度：100元-30000元" afterInheritingLabelAttributesAndConfiguringWithBlock:^NSMutableAttributedString *(NSMutableAttributedString *mutableAttributedString) {
        NSRange range = [[mutableAttributedString string] rangeOfString:@"额度：" options:NSCaseInsensitiveSearch];
        [mutableAttributedString addAttribute:(NSString *)kCTForegroundColorAttributeName value:[UIColor colorWithHexString:@"#333333"] range:range];
        return mutableAttributedString;
    }];
    [cell setLoanType:LoanTypeHighPassRate];
    
    return cell;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    
}

@end
